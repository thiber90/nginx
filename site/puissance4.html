<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Connect 4</title>
    <link rel="stylesheet" type="text/css" href="puissance4.css">
    <script src="jquery-3.5.1.js"></script>
    <script src="puissance4.js"></script>
</head>

<body>
    <h1>Connect 4</h1>
    <p>Instructions: Click on a column to drop your disc. The AI will then make its move.</p>
    <table id="connect4Grid">
        <!-- The grid will be dynamically generated by JavaScript -->
    </table>
    <div id="gameStatus">Your turn</div> <!-- Panel to display game status -->
    <br>
    <button id="startButton">Start Game</button>

    <script>
        $(document).ready(function () {
            let turnCounter = 1; // Initialize turn counter
            let lastMoveHash = ''; // Initialize last move hash
            let gameOver = false; // Initialize game over flag
            let aiComputing = false; // Initialize AI computing flag

            // Initialize the game
            function initializeGame() {
                grille = Grille.generateEmptyGrid();
                generateGrid();
                updateGrid(); // Call updateGrid to set the initial playable cells
                turnCounter = 1; // Reset turn counter
                lastMoveHash = ''; // Reset last move hash
                gameOver = false; // Reset game over flag
                aiComputing = false; // Reset AI computing flag
                $('#gameStatus').text('Your turn'); // Set initial game status
            }

            // Generate the Connect 4 grid
            function generateGrid() {
                let table = $('#connect4Grid');
                table.empty();
                for (let i = 5; i >= 0; i--) { // Start from the bottom row
                    let row = $('<tr></tr>');
                    for (let j = 0; j < 7; j++) {
                        let cell = $('<td></td>').attr('data-x', j).attr('data-y', i);
                        row.append(cell);
                    }
                    table.append(row);
                }
            }

            // Handle cell click
            $('#connect4Grid').on('click', 'td.playable', function () {
                if (gameOver || aiComputing) return; // Prevent clicks if the game is over or AI is computing

                let x = $(this).data('x');
                let y = grille.getNumberInColumn(x);
                if (y < 6) {
                    let point = new Point(x, y);
                    point.setValeur(1); // Assuming 1 is the human player
                    grille.getPoint(x, y).setValeur(1);
                    let rootNode = new Node(grille, turnCounter, lastMoveHash); // Create a new node for the human move
                    lastMoveHash = rootNode.hash; // Update last move hash
                    updateGrid();
                    if (evaluateSituationWin(grille, 1)) {
                        $('#gameStatus').text('You win!');
                        gameOver = true;
                        return;
                    }
                    turnCounter++; // Increment turn counter for AI's turn
                    $('#gameStatus').text('IA computing'); // Update game status
                    aiComputing = true; // Set AI computing flag
                    setTimeout(function () { // Simulate AI thinking time
                        if (playIA(turnCounter, lastMoveHash)) {
                            $('#gameStatus').text('IA wins!');
                            gameOver = true;
                        } else {
                            $('#gameStatus').text('Your turn'); // Update game status
                        }
                        aiComputing = false; // Reset AI computing flag
                        turnCounter++; // Increment turn counter for next human turn
                        updateGrid();
                    }, 500); // Simulate a delay for AI computation
                }
            });

            // Update the grid display
            function updateGrid() {
                for (let i = 0; i < 6; i++) {
                    for (let j = 0; j < 7; j++) {
                        let point = grille.getPoint(j, i);
                        let cell = $('td[data-x=' + j + '][data-y=' + i + ']');
                        if (point.valeur === 1) {
                            cell.removeClass('playable').addClass('player1');
                        } else if (point.valeur === 2) {
                            cell.removeClass('playable').addClass('player2');
                        } else {
                            cell.removeClass('player1 player2 playable');
                        }
                    }
                }

                // Add the playable class only to the topmost empty cell in each column
                for (let j = 0; j < 7; j++) {
                    let y = grille.getNumberInColumn(j);
                    if (y < 6) {
                        let cell = $('td[data-x=' + j + '][data-y=' + y + ']');
                        cell.addClass('playable');
                    }
                }
            }

            // Start the game
            $('#startButton').click(function () {
                initializeGame();
            });

            // Initialize the game on page load
            initializeGame();
        });
    </script>
    <div class="footer">
        Developed by Thibaut B. - thiber90@gmail.com
    </div>
</body>

</html>